<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Dashboard</title>
    <style>
        :root {
            --table-border-color: #ddd;
            --table-header-bg: #f2f2f2;
            --table-row-hover-bg: #f5f5f5;
            --status-scraped-bg: #f3e5f5;
            --status-scraped-color: #7b1fa2;
            --status-accepted-bg: #e8f5e9;
            --status-accepted-color: #388e3c;
            --status-rejected-bg: #ffebee;
            --status-rejected-color: #c62828;
            --status-applied-bg: #e3f2fd;
            --status-applied-color: #1565c0;
            --status-sent-bg: #f3e5f5;
            --status-sent-color: #8e24aa;
            --status-open-bg: #e8eaf6;
            --status-open-color: #3949ab;
            --status-archived-bg: #f5f5f5;
            --status-archived-color: #616161;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 2rem; background-color: #fafafa; }
        h1 { text-align: center; color: #333; }
        .header-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        #last-updated { font-size: 0.8rem; color: #666; background-color: #f0f0f0; padding: 0.3rem 0.6rem; border-radius: 4px; }
        #dashboard-controls { display: flex; justify-content: space-between; align-items: stretch; margin-bottom: 1rem; padding: 1rem; background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); gap: 1rem; }
        .control-group { border: 1px solid #e0e0e0; padding: 0.75rem; border-radius: 6px; display: flex; flex-direction: column; gap: 0.5rem; }
        .control-group legend { font-weight: bold; padding: 0 0.25rem; font-size: 0.9rem; color: #333; }
        #stats-container { display: flex; gap: 1rem; font-size: 0.9rem; color: #555; align-items: center; }
        .stat-card { background: #f9f9f9; padding: 0.5rem 1rem; border-radius: 6px; border: 1px solid #eee; }
        #dashboard-controls input, #dashboard-controls select { padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc; }
        #project-table { width: 100%; border-collapse: collapse; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        #project-table th, #project-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--table-border-color); }
        #project-table th { background-color: var(--table-header-bg); cursor: pointer; user-select: none; }
        #project-table th:hover { background-color: #e0e0e0; }
        #project-table tbody tr:hover { background-color: var(--table-row-hover-bg); }
        .status-badge { padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem; font-weight: bold; text-transform: capitalize; }
        .status-scraped { background-color: var(--status-scraped-bg); color: var(--status-scraped-color); }
        .status-accepted { background-color: var(--status-accepted-bg); color: var(--status-accepted-color); }
        .status-rejected { background-color: var(--status-rejected-bg); color: var(--status-rejected-color); }
        .status-applied { background-color: var(--status-applied-bg); color: var(--status-applied-color); }
        .status-sent { background-color: var(--status-sent-bg); color: var(--status-sent-color); }
        .status-open { background-color: var(--status-open-bg); color: var(--status-open-color); }
        .status-archived { background-color: var(--status-archived-bg); color: var(--status-archived-color); }
        a { color: #1e88e5; text-decoration: none; }
        a:hover { text-decoration: underline; }

        /* Application Generation Button Styles */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.8rem;
            border: 1px solid;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            transition: all 0.2s ease;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-view {
            background: #6c757d;
            color: white;
            border-color: #6c757d;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border-color: #6c757d;
        }

        .btn-outline {
            background: transparent;
            color: #007bff;
            border-color: #007bff;
        }

        .btn-outline:hover {
            background: #007bff;
            color: white;
        }

        .btn-move {
            font-size: 0.75rem;
            padding: 0.2rem 0.4rem;
        }

        .btn-script {
            font-size: 0.75rem;
            padding: 0.2rem 0.4rem;
        }

        .btn-generate {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .btn-generate.queued {
            background: #ffc107;
            border-color: #ffc107;
            color: black;
        }

        .btn-generate.processing {
            background: #6c757d;
            border-color: #6c757d;
            color: white;
        }

        .btn-generate.success {
            background: #28a745;
            border-color: #28a745;
            color: white;
        }

        .btn-generate.failed {
            background: #dc3545;
            border-color: #dc3545;
            color: white;
        }

        .btn-spinner {
            display: none;
            animation: spin 1s linear infinite;
        }

        .btn-spinner.visible {
            display: inline;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .btn-text {
            display: inline;
        }

        /* Queue status indicator */
        .queue-status {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 0.5rem;
            font-size: 0.8rem;
            z-index: 1000;
            display: none;
        }

        .queue-status.visible {
            display: block;
        }
    </style>
</head>
<body>

    <div class="header-container">
        <h1>Project Application Dashboard</h1>
        <div id="last-updated">Last Updated: Loading...</div>
    </div>

    <div id="dashboard-controls">
        <fieldset class="control-group">
            <legend>Search & Filter</legend>
            <input type="text" id="search-input" placeholder="Search by title...">
            <div>
                <label>Status:</label>
                <input type="checkbox" id="filter-scraped" value="scraped"> <label for="filter-scraped">Scraped</label>
                <input type="checkbox" id="filter-accepted" value="accepted" checked> <label for="filter-accepted">Accepted</label>
                <input type="checkbox" id="filter-rejected" value="rejected" checked> <label for="filter-rejected">Rejected</label>
                <input type="checkbox" id="filter-applied" value="applied" checked> <label for="filter-applied">Applied</label>
                <input type="checkbox" id="filter-sent" value="sent"> <label for="filter-sent">Sent</label>
                <input type="checkbox" id="filter-open" value="open"> <label for="filter-open">Open</label>
                <input type="checkbox" id="filter-archived" value="archived"> <label for="filter-archived">Archived</label>
            </div>
        </fieldset>

        <fieldset class="control-group">
            <legend>Date Range</legend>
            <input type="date" id="start-date">
            <input type="date" id="end-date">
            <select id="date-preset">
                <option value="">Select Range</option>
                <option value="all_time">All Time</option>
                <option value="today">Today</option>
                <option value="last_day">Last Day</option>
                <option value="last_2_days">Last 2 Days</option>
                <option value="last_3_days">Last 3 Days</option>
                <option value="last_week">Last Week</option>
                <option value="last_2_weeks">Last 2 Weeks</option>
                <option value="last_month">Last Month</option>
            </select>
        </fieldset>

        <fieldset class="control-group">
            <legend>Views & Stats</legend>
            <div id="stats-container">
                <!-- Stats will be rendered here -->
            </div>
            <select id="view-preset-select">
                <option value="">Select View</option>
                <!-- Presets will be loaded here -->
            </select>
        </fieldset>

        <fieldset class="control-group">
            <legend>Actions</legend>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="executeScript('main')" data-script="main">
                    Run Full Workflow
                </button>
                <button class="btn btn-outline" onclick="executeScript('evaluate')" data-script="evaluate">
                    Evaluate All Projects
                </button>
                <button class="btn btn-outline" onclick="executeScript('generate')" data-script="generate">
                    Generate Applications
                </button>
                <button class="btn btn-outline" onclick="refreshDashboard()">
                    Refresh Dashboard
                </button>
            </div>
        </fieldset>
    </div>

    <!-- Queue Status Indicator -->
    <div id="queue-status" class="queue-status">
        <div id="queue-stats">Queue: 0 | Processing: 0 | Responses: 0</div>
        <div id="queue-activity">Ready</div>
    </div>

    <table id="project-table">
        <thead>
            <tr>
                <th data-sort="retrieval_date">Retrieval Date</th>
                <th data-sort="eingestellt_date">Eingestellt Date</th>
                <th data-sort="title">Project Title</th>
                <th data-sort="company">Company</th>
                <th data-sort="pre_eval_score">Pre-eval Score</th>
                <th data-sort="llm_score">LLM Score</th>
                <th data-sort="status">Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="table-body">
            <!-- Project rows will be inserted here -->
        </tbody>
    </table>

    <script>
let projectData = {
  "generated_at": "2025-08-29T17:29:51.193604",
  "total_projects": 10,
  "projects": [
    {
      "id": "20250829_162112_QC_Analyst_Senior_-_French,_LC-MS",
      "title": "20250829_162112_QC_Analyst_Senior_-_French,_LC-MS",
      "retrieval_date": "2025-08-29T16:21:12",
      "eingestellt_date": "2025-08-29",
      "pre_eval_score": 7,
      "llm_score": 0,
      "status": "rejected",
      "file_path": "projects/20250829_162112_QC_Analyst_Senior_-_French,_LC-MS.md",
      "url": "https://www.freelancermap.ch/projekt/qc-analyst-senior-french-lc-ms-2913905?ref=rss",
      "company": "RM Group",
      "application_date": null
    },
    {
      "id": "20250829_162108_Freelance_(Senior)_ABAP_Engineer_mit_AIF_BTP_(m_w_d)_-_Projektchance_in_Hamburg",
      "title": "20250829_162108_Freelance_(Senior)_ABAP_Engineer_mit_AIF_BTP_(m_w_d)_-_Projektchance_in_Hamburg",
      "retrieval_date": "2025-08-29T16:21:08",
      "eingestellt_date": "2025-08-29",
      "pre_eval_score": 6,
      "llm_score": 0,
      "status": "rejected",
      "file_path": "projects/20250829_162108_Freelance_(Senior)_ABAP_Engineer_mit_AIF_BTP_(m_w_d)_-_Projektchance_in_Hamburg.md",
      "url": "https://www.freelancermap.de/projekt/freelance-senior-abap-engineer-mit-aif-btp-m-w-d-projektchance-in-hamburg?ref=rss",
      "company": "Axzoom GmbH",
      "application_date": null
    },
    {
      "id": "20250829_162110_SAP_EWM_Consultant_(m_w_d)",
      "title": "20250829_162110_SAP_EWM_Consultant_(m_w_d)",
      "retrieval_date": "2025-08-29T16:21:10",
      "eingestellt_date": "2025-08-29",
      "pre_eval_score": 27,
      "llm_score": 35,
      "status": "rejected",
      "file_path": "projects/20250829_162110_SAP_EWM_Consultant_(m_w_d).md",
      "url": "https://www.freelancermap.at/projekt/sap-ewm-consultant-m-w-d-2913891?ref=rss",
      "company": "Hays AG",
      "application_date": null
    },
    {
      "id": "20250829_162108_Batch-Operator_(m_w_d)_-_CHA13271_-_Constaff_GmbH",
      "title": "20250829_162108_Batch-Operator_(m_w_d)_-_CHA13271_-_Constaff_GmbH",
      "retrieval_date": "2025-08-29T16:21:08",
      "eingestellt_date": "2025-08-29",
      "pre_eval_score": 8,
      "llm_score": 0,
      "status": "rejected",
      "file_path": "projects/20250829_162108_Batch-Operator_(m_w_d)_-_CHA13271_-_Constaff_GmbH.md",
      "url": "https://www.freelancermap.de/projekt/batch-operator-m-w-d-cha13271-constaff-gmbh?ref=rss",
      "company": "Constaff GmbH",
      "application_date": null
    },
    {
      "id": "20250829_162108_Senior_Entwickler_(ECON_Suite___CIB_Workbench)_gesucht_(m_w_d)",
      "title": "20250829_162108_Senior_Entwickler_(ECON_Suite___CIB_Workbench)_gesucht_(m_w_d)",
      "retrieval_date": "2025-08-29T16:21:08",
      "eingestellt_date": "2025-08-29",
      "pre_eval_score": 6,
      "llm_score": 0,
      "status": "rejected",
      "file_path": "projects/20250829_162108_Senior_Entwickler_(ECON_Suite___CIB_Workbench)_gesucht_(m_w_d).md",
      "url": "https://www.freelancermap.de/projekt/senior-entwickler-econ-suite-cib-workbench-gesucht-m-w-d?ref=rss",
      "company": "VirtoTech",
      "application_date": null
    },
    {
      "id": "20250829_134848_Regulatory_Operations_Specialist_-_Product_Chemistry",
      "title": "20250829_134848_Regulatory_Operations_Specialist_-_Product_Chemistry",
      "retrieval_date": "2025-08-29T13:48:48",
      "eingestellt_date": "2025-08-29",
      "pre_eval_score": 26,
      "llm_score": 12,
      "status": "rejected",
      "file_path": "projects/20250829_134848_Regulatory_Operations_Specialist_-_Product_Chemistry.md",
      "url": "https://www.freelancermap.ch/projekt/regulatory-operations-specialist-product-chemistry?ref=rss",
      "company": "RM Group",
      "application_date": null
    },
    {
      "id": "20250829_162110_SAP_S_4HANA_Embedded_Analytics_Consultant_(m_f_d)",
      "title": "20250829_162110_SAP_S_4HANA_Embedded_Analytics_Consultant_(m_f_d)",
      "retrieval_date": "2025-08-29T16:21:10",
      "eingestellt_date": "2025-08-29",
      "pre_eval_score": 26,
      "llm_score": 30,
      "status": "rejected",
      "file_path": "projects/20250829_162110_SAP_S_4HANA_Embedded_Analytics_Consultant_(m_f_d).md",
      "url": "https://www.freelancermap.at/projekt/sap-s-4hana-embedded-analytics-consultant-m-f-d-2913887?ref=rss",
      "company": "Hays AG",
      "application_date": null
    },
    {
      "id": "20250829_162109_Cloud_Consultant___Azure_Security_&_Compliance_(m_w_d)",
      "title": "20250829_162109_Cloud_Consultant___Azure_Security_&_Compliance_(m_w_d)",
      "retrieval_date": "2025-08-29T16:21:09",
      "eingestellt_date": "2025-08-29",
      "pre_eval_score": 32,
      "llm_score": 70,
      "status": "rejected",
      "file_path": "projects/20250829_162109_Cloud_Consultant___Azure_Security_&_Compliance_(m_w_d).md",
      "url": "https://www.freelancermap.de/projekt/cloud-consultant-azure-security-und-compliance-m-w-d?ref=rss",
      "company": "Tergos GmbH",
      "application_date": null
    },
    {
      "id": "20250829_162111_Python_Developer_(A)",
      "title": "20250829_162111_Python_Developer_(A)",
      "retrieval_date": "2025-08-29T16:21:11",
      "eingestellt_date": "2025-08-29",
      "pre_eval_score": 27,
      "llm_score": 82,
      "status": "sent",
      "file_path": "projects/20250829_162111_Python_Developer_(A).md",
      "url": "https://www.freelancermap.ch/projekt/python-developer-a-2913916?ref=rss",
      "company": "Bosshard & Partner Unternehmensberatung AG",
      "application_date": null
    },
    {
      "id": "20250829_162109_Freelance_(Senior)_SAP_DRC_Tax_Consultant_(m_w_d)_-_Projektchance_in_Hamburg",
      "title": "20250829_162109_Freelance_(Senior)_SAP_DRC_Tax_Consultant_(m_w_d)_-_Projektchance_in_Hamburg",
      "retrieval_date": "2025-08-29T16:21:09",
      "eingestellt_date": "2025-08-29",
      "pre_eval_score": 7,
      "llm_score": 0,
      "status": "rejected",
      "file_path": "projects/20250829_162109_Freelance_(Senior)_SAP_DRC_Tax_Consultant_(m_w_d)_-_Projektchance_in_Hamburg.md",
      "url": "https://www.freelancermap.de/projekt/freelance-senior-sap-drc-tax-consultant-m-w-d-projektchance-in-hamburg?ref=rss",
      "company": "Axzoom GmbH",
      "application_date": null
    }
  ]
};

        // Function to fetch dashboard data
        async function fetchDashboardData() {
            try {
                const response = await fetch('/api/dashboard-data');
                const result = await response.json();
                if (result.success && result.data) {
                    projectData = result.data;
                    return projectData;
                } else {
                    throw new Error(result.error || 'Failed to fetch dashboard data');
                }
            } catch (error) {
                console.error('Error fetching dashboard data:', error);
                throw error;
            }
        }
    </script>
    <script>
        // Application Queue Management Class
        class ApplicationQueue {
            constructor() {
                this.pollInterval = 2000; // Poll every 2 seconds
                this.activeRequests = new Map();
                this.responseCache = new Map();
                this.startStatusPolling();
                this.updateQueueStatus();
            }

            async generateApplication(projectId, projectFile) {
                const requestId = this.createRequestId();
                const request = {
                    request_id: requestId,
                    timestamp: new Date().toISOString(),
                    project_id: projectId,
                    project_file: projectFile,
                    action: 'generate_application',
                    user_agent: 'dashboard-v1.0'
                };

                try {
                    // Create and download request file
                    await this.writeRequestFile(requestId, request);

                    // Track the request
                    this.trackRequest(requestId, projectId);

                    // Update button state
                    this.updateButtonState(projectId, 'queued');

                    // Update queue status
                    this.updateQueueStatus();

                    console.log(`Queued application generation for project: ${projectId}`);
                } catch (error) {
                    console.error('Failed to queue application generation:', error);
                    this.updateButtonState(projectId, 'failed');
                }
            }

            createRequestId() {
                const timestamp = Date.now();
                const random = Math.random().toString(36).substring(2, 8);
                return `req_${timestamp}_${random}`;
            }

            async writeRequestFile(requestId, request) {
                const jsonContent = JSON.stringify(request, null, 2);
                const blob = new Blob([jsonContent], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                // Create download link and trigger download
                const a = document.createElement('a');
                a.href = url;
                a.download = `application_queue/requests/${requestId}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                // Clean up blob URL
                URL.revokeObjectURL(url);
            }

            trackRequest(requestId, projectId) {
                this.activeRequests.set(requestId, {
                    projectId: projectId,
                    timestamp: Date.now(),
                    status: 'queued'
                });
            }

            updateButtonState(projectId, status) {
                const button = document.getElementById(`btn-${projectId}`);
                const spinner = document.getElementById(`spinner-${projectId}`);

                if (!button) return;

                // Remove all status classes
                button.classList.remove('queued', 'processing', 'success', 'failed');

                // Update button appearance
                switch (status) {
                    case 'queued':
                        button.classList.add('queued');
                        button.innerHTML = '<span class="btn-text">Queued</span><span class="btn-spinner">⟳</span>';
                        button.disabled = true;
                        break;
                    case 'processing':
                        button.classList.add('processing');
                        button.innerHTML = '<span class="btn-text">Processing</span><span class="btn-spinner">⟳</span>';
                        button.disabled = true;
                        if (spinner) spinner.classList.add('visible');
                        break;
                    case 'success':
                        button.classList.add('success');
                        button.innerHTML = '<span class="btn-text">Success ✅</span>';
                        button.disabled = true;
                        if (spinner) spinner.classList.remove('visible');
                        break;
                    case 'failed':
                        button.classList.add('failed');
                        button.innerHTML = '<span class="btn-text">Failed ❌</span>';
                        button.disabled = false;
                        if (spinner) spinner.classList.remove('visible');
                        break;
                    default:
                        button.innerHTML = '<span class="btn-text">Generate App</span><span class="btn-spinner">⟳</span>';
                        button.disabled = false;
                        if (spinner) spinner.classList.remove('visible');
                }
            }

            startStatusPolling() {
                setInterval(() => {
                    this.checkResponseFiles();
                    this.updateQueueStatus();
                }, this.pollInterval);
            }

            async checkResponseFiles() {
                // This is a simplified version - in a real implementation,
                // you might use the File System Access API or ask users to upload response files
                // For now, we'll simulate checking for responses

                // In a production implementation, you could:
                // 1. Use File System Access API (limited browser support)
                // 2. Ask users to manually upload response files
                // 3. Use a local server endpoint
                // 4. Poll a local directory via a browser extension

                // For this demo, we'll show how the system would work
                // by simulating responses for active requests

                for (const [requestId, request] of this.activeRequests) {
                    // Simulate finding a response (in real implementation, check response directory)
                    if (Math.random() < 0.1) { // 10% chance every 2 seconds
                        const mockResponse = {
                            request_id: requestId,
                            status: Math.random() < 0.8 ? 'success' : 'failed',
                            project_id: request.projectId,
                            result: {
                                application_generated: true,
                                tokens_used: Math.floor(Math.random() * 1000) + 500,
                                cost: (Math.random() * 0.01).toFixed(4),
                                moved_to_applied: true
                            },
                            error: null
                        };

                        this.processResponse(mockResponse);
                        this.activeRequests.delete(requestId);
                    }
                }
            }

            processResponse(response) {
                const { request_id, status, project_id, result, error } = response;

                console.log(`Processing response for ${project_id}: ${status}`);

                // Update button state
                this.updateButtonState(project_id, status);

                // Show notification
                this.showNotification(project_id, status, result, error);

                // If successful, refresh dashboard data after a delay
                if (status === 'success') {
                    setTimeout(() => {
                        // In a real implementation, you would refresh the dashboard data
                        console.log('Refreshing dashboard data...');
                        // loadProjectData(); // This would be called to refresh
                    }, 2000);
                }
            }

            showNotification(projectId, status, result, error) {
                const message = status === 'success'
                    ? `✅ Application generated for project ${projectId} (${result?.tokens_used} tokens, $${result?.cost})`
                    : `❌ Failed to generate application for project ${projectId}: ${error || 'Unknown error'}`;

                // Simple notification - in a real implementation, you might use a proper notification system
                console.log(message);

                // You could also show a toast notification here
                // this.showToast(message, status === 'success' ? 'success' : 'error');
            }

            updateQueueStatus() {
                const queueStatus = document.getElementById('queue-status');
                const queueStats = document.getElementById('queue-stats');
                const queueActivity = document.getElementById('queue-activity');

                if (!queueStats || !queueActivity) return;

                const activeCount = this.activeRequests.size;
                const processingCount = Array.from(this.activeRequests.values())
                    .filter(req => req.status === 'processing').length;

                queueStats.textContent = `Queue: ${activeCount} | Processing: ${processingCount} | Responses: ${this.responseCache.size}`;

                if (activeCount > 0) {
                    queueStatus.classList.add('visible');
                    queueActivity.textContent = `Active requests: ${Array.from(this.activeRequests.keys()).join(', ')}`;
                } else {
                    queueStatus.classList.remove('visible');
                    queueActivity.textContent = 'Ready';
                }
            }
        }

        // Global ApplicationQueue instance
        let appQueue;

        // Dashboard API Client Class
        class DashboardAPI {
            constructor() {
                this.baseURL = 'http://localhost:8001';
            }

            async moveProject(projectId, fromStatus, toStatus) {
                try {
                    const response = await fetch(`${this.baseURL}/api/move-project`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            projectId: projectId,
                            fromStatus: fromStatus,
                            toStatus: toStatus
                        })
                    });

                    const result = await response.json();
                    return result;
                } catch (error) {
                    console.error('API Error:', error);
                    return { success: false, error: error.message };
                }
            }

            async executeScript(scriptName, params = {}) {
                try {
                    const response = await fetch(`${this.baseURL}/api/execute-script`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            script: scriptName,
                            params: params
                        })
                    });

                    const result = await response.json();
                    return result;
                } catch (error) {
                    console.error('API Error:', error);
                    return { success: false, error: error.message };
                }
            }

            async refreshDashboard() {
                try {
                    // Add cache-busting query param and explicit no-store caching directives
                    const url = `${this.baseURL}/api/dashboard-data?t=${Date.now()}`;
                    const response = await fetch(url, {
                        method: 'GET',
                        cache: 'no-store',
                        headers: {
                            'Cache-Control': 'no-cache, no-store, max-age=0, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        }
                    });
                    
                    const result = await response.json();
                    return result;
                } catch (error) {
                    console.error('API Error:', error);
                    return { success: false, error: error.message };
                }
            }
        }

        // Global API instance
        let dashboardAPI;

        // Global function for button onclick handlers
        async function generateApplication(projectId, projectFile) {
            if (!dashboardAPI) {
                console.error('DashboardAPI not initialized');
                return;
            }

            // Show loading state
            const button = document.getElementById(`btn-${projectId}`);
            if (button) {
                button.disabled = true;
                button.innerHTML = '<span class="btn-text">Generating...</span><span class="btn-spinner">⟳</span>';
            }

            try {
                // Extract project file name from path for the API call
                const projectFileName = projectFile.split('/').pop();

                const result = await dashboardAPI.executeScript('generate', {
                    project_file: projectFileName
                });

                if (result.success) {
                    showNotification(`✅ Application generated for project ${projectId}`, 'success');
                    // Refresh dashboard data after a short delay
                    setTimeout(() => {
                        refreshDashboard();
                    }, 2000);
                } else {
                    showNotification(`❌ Failed to generate application: ${result.error || result.output}`, 'error');
                    if (button) {
                        button.disabled = false;
                        button.innerHTML = '<span class="btn-text">Generate App</span><span class="btn-spinner">⟳</span>';
                    }
                }
            } catch (error) {
                showNotification(`❌ Error: ${error.message}`, 'error');
                if (button) {
                    button.disabled = false;
                    button.innerHTML = '<span class="btn-text">Generate App</span><span class="btn-spinner">⟳</span>';
                }
            }
        }

        // New global functions for dynamic operations
        async function moveProject(projectId, fromStatus, toStatus) {
            if (!dashboardAPI) {
                console.error('DashboardAPI not initialized');
                return;
            }

            // Show loading state
            const button = document.querySelector(`[data-project-id="${projectId}"] .btn-move`);
            if (button) {
                button.disabled = true;
                button.innerHTML = 'Moving...';
            }

            try {
                const result = await dashboardAPI.moveProject(projectId, fromStatus, toStatus);

                if (result.success) {
                    showNotification(`✅ Project moved from ${fromStatus} to ${toStatus}`, 'success');
                    // Refresh dashboard data after a short delay
                    setTimeout(() => {
                        refreshDashboard();
                    }, 1000);
                } else {
                    showNotification(`❌ Failed to move project: ${result.error || result.message}`, 'error');
                    if (button) {
                        button.disabled = false;
                        button.innerHTML = `Move to ${toStatus}`;
                    }
                }
            } catch (error) {
                showNotification(`❌ Error: ${error.message}`, 'error');
                if (button) {
                    button.disabled = false;
                    button.innerHTML = `Move to ${toStatus}`;
                }
            }
        }

        async function executeScript(scriptName, params = {}) {
            if (!dashboardAPI) {
                console.error('DashboardAPI not initialized');
                return;
            }

            // Show loading state
            const button = document.querySelector(`[data-script="${scriptName}"]`);
            if (button) {
                button.disabled = true;
                button.innerHTML = 'Running...';
            }

            try {
                const result = await dashboardAPI.executeScript(scriptName, params);

                if (result.success) {
                    showNotification(`✅ Script ${scriptName} executed successfully`, 'success');
                    // Refresh dashboard data after execution
                    setTimeout(() => {
                        refreshDashboard();
                    }, 2000);
                } else {
                    showNotification(`❌ Script execution failed: ${result.error || result.output}`, 'error');
                    if (button) {
                        button.disabled = false;
                        button.innerHTML = `Run ${scriptName}`;
                    }
                }
            } catch (error) {
                showNotification(`❌ Error: ${error.message}`, 'error');
                if (button) {
                    button.disabled = false;
                    button.innerHTML = `Run ${scriptName}`;
                }
            }
        }

        async function refreshDashboard() {
            if (!dashboardAPI) {
                console.error('DashboardAPI not initialized');
                return;
            }

            // Show loading state
            const button = document.querySelector('button[onclick*="refreshDashboard"]');
            if (button) {
                button.disabled = true;
                button.innerHTML = 'Refreshing...';
            }

            try {
                const result = await dashboardAPI.refreshDashboard();

                if (result.success && result.data) {
                    // Update the global projectData variable
                    window.projectData = result.data;

                    // Force-update UI timestamp immediately to avoid any cached state
                    const lastUpdatedEl = document.getElementById('last-updated');
                    if (lastUpdatedEl && result.data.generated_at) {
                        const ts = new Date(result.data.generated_at).toLocaleString();
                        lastUpdatedEl.textContent = `Last Updated: ${ts}`;
                    }

                    // Reload the data in the current session
                    if (typeof loadProjectData === 'function') {
                        loadProjectData();
                    }

                    showNotification(`✅ Dashboard refreshed successfully`, 'success');
                } else {
                    showNotification(`❌ Failed to refresh dashboard: ${result.error || 'Unknown error'}`, 'error');
                }

                if (button) {
                    button.disabled = false;
                    button.innerHTML = 'Refresh Dashboard';
                }
            } catch (error) {
                showNotification(`❌ Error refreshing dashboard: ${error.message}`, 'error');
                if (button) {
                    button.disabled = false;
                    button.innerHTML = 'Refresh Dashboard';
                }
            }
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem;
                border-radius: 4px;
                color: white;
                font-weight: bold;
                z-index: 10000;
                max-width: 400px;
                word-wrap: break-word;
            `;

            if (type === 'success') {
                notification.style.backgroundColor = '#28a745';
            } else if (type === 'error') {
                notification.style.backgroundColor = '#dc3545';
            } else {
                notification.style.backgroundColor = '#007bff';
            }

            notification.textContent = message;
            document.body.appendChild(notification).

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        document.addEventListener("DOMContentLoaded", () => {
            const tableBody = document.getElementById("table-body");
            let allProjects = [];
            let currentSort = { column: 'retrieval_date', order: 'desc' };

            // Initialize ApplicationQueue
            appQueue = new ApplicationQueue();

            // Initialize DashboardAPI
            dashboardAPI = new DashboardAPI();
            const viewPresets = {
                "default": {
                    "filters": {
                        "scraped": false,
                        "accepted": true,
                        "rejected": false,
                        "applied": true,
                        "sent": false,
                        "open": false,
                        "archived": false
                    },
                    "name": "Default View",
                    "date_range": "last_month"
                },
                "all": {
                    "filters": {
                        "scraped": true,
                        "accepted": true,
                        "rejected": true,
                        "applied": true,
                        "sent": true,
                        "open": true,
                        "archived": true
                    },
                    "name": "All Projects",
                    "date_range": "all_time"
                },
                "review": {
                    "filters": {
                        "scraped": false,
                        "accepted": true,
                        "rejected": false,
                        "applied": false,
                        "sent": false,
                        "open": false,
                        "archived": false
                    },
                    "name": "Review Queue",
                    "date_range": "last_3_days"
                },
                "active": {
                    "filters": {
                        "scraped": false,
                        "accepted": true,
                        "rejected": false,
                        "applied": true,
                        "sent": true,
                        "open": true,
                        "archived": false
                    },
                    "name": "Active Projects",
                    "date_range": "last_week"
                }
            };

            function populateViewPresets() {
                const selectElement = document.getElementById('view-preset-select');
                for (const key in viewPresets) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = viewPresets[key].name;
                    selectElement.appendChild(option);
                }
            }

            function loadProjectData() {
                try {
                    // Prefer live window.projectData (updated by refresh), fallback to embedded global if present
                    const src = (typeof window !== 'undefined' && window.projectData)
                        ? window.projectData
                        : (typeof projectData !== 'undefined' ? projectData : null);

                    if (src && src.projects) {
                        allProjects = src.projects;
                        if (src.generated_at) {
                            const lastUpdated = new Date(src.generated_at).toLocaleString();
                            document.getElementById('last-updated').textContent = `Last Updated: ${lastUpdated}`;
                        }
                        renderTable();
                    } else {
                        throw new Error("Project data is not defined or invalid.");
                    }
                } catch (error) {
                    console.error("Error loading dashboard data:", error);
                    tableBody.innerHTML = `<tr><td colspan="8" style="text-align: center; color: red;">Error loading data. Run the Python script to generate dashboard data.</td></tr>`;
                }
            }

            function renderTable() {
                const statsContainer = document.getElementById("stats-container");
                // Filtering logic
                const searchTherm = document.getElementById('search-input').value.toLowerCase();
                const scraped = document.getElementById('filter-scraped').checked;
                const accepted = document.getElementById('filter-accepted').checked;
                const rejected = document.getElementById('filter-rejected').checked;
                const applied = document.getElementById('filter-applied').checked;
                const sent = document.getElementById('filter-sent').checked;
                const open = document.getElementById('filter-open').checked;
                const archived = document.getElementById('filter-archived').checked;
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;

                let filteredProjects = allProjects.filter(p => {
                    const statusMatch = (scraped && p.status === 'scraped') ||
                                       (accepted && p.status === 'accepted') ||
                                       (rejected && p.status === 'rejected') ||
                                       (applied && p.status === 'applied') ||
                                       (sent && p.status === 'sent') ||
                                       (open && p.status === 'open') ||
                                       (archived && p.status === 'archived');

                    const searchMatch = p.title.toLowerCase().includes(searchTherm);

                    const retrievalDate = p.retrieval_date ? p.retrieval_date.split('T')[0] : '';
                    const dateMatch = (!startDate || retrievalDate >= startDate) &&
                                     (!endDate || retrievalDate <= endDate);

                    return statusMatch && searchMatch && dateMatch;
                });

                // Sorting logic
                filteredProjects.sort((a, b) => {
                    let valA = a[currentSort.column] || '';
                    let valB = b[currentSort.column] || '';
                    
                    if (typeof valA === 'string') valA = valA.toLowerCase();
                    if (typeof valB === 'string') valB = valB.toLowerCase();

                    if (valA < valB) return currentSort.order === 'asc' ? -1 : 1;
                    if (valA > valB) return currentSort.order === 'asc' ? 1 : -1;
                    return 0;
                });
                
                // Stats calculation
                const stats = {
                    scraped: 0,
                    accepted: 0,
                    rejected: 0,
                    applied: 0,
                    sent: 0,
                    open: 0,
                    archived: 0,
                    total: filteredProjects.length
                };

                filteredProjects.forEach(p => {
                    if (stats[p.status] !== undefined) {
                        stats[p.status]++;
                    }
                });

                statsContainer.innerHTML = `
                    <div class="stat-card"><strong>Total:</strong> ${stats.total}</div>
                    <div class="stat-card status-scraped"><strong>Scraped:</strong> ${stats.scraped}</div>
                    <div class="stat-card status-accepted"><strong>Accepted:</strong> ${stats.accepted}</div>
                    <div class="stat-card status-rejected"><strong>Rejected:</strong> ${stats.rejected}</div>
                    <div class="stat-card status-applied"><strong>Applied:</strong> ${stats.applied}</div>
                    <div class="stat-card status-sent"><strong>Sent:</strong> ${stats.sent}</div>
                    <div class="stat-card status-open"><strong>Open:</strong> ${stats.open}</div>
                    <div class="stat-card status-archived"><strong>Archived:</strong> ${stats.archived}</div>
                `;

                tableBody.innerHTML = filteredProjects.map(project => {
                    // Action buttons based on project status
                    let actionButtons = '';

                    if (project.status === 'accepted') {
                        actionButtons = `
                            <button class="btn btn-generate"
                                    onclick="generateApplication('${project.id}', '${project.file_path}')"
                                    data-project-id="${project.id}"
                                    id="btn-${project.id}">
                                <span class="btn-text">Generate App</span>
                                <span class="btn-spinner" id="spinner-${project.id}">⟳</span>
                            </button>
                        `;
                    } else if (project.status === 'applied') {
                        actionButtons = `
                            <button class="btn btn-secondary"
                                    onclick="executeScript('main', {'project_file': '${project.file_path}'})">
                                Send Application
                            </button>
                        `;
                    } else if (project.status === 'sent') {
                        actionButtons = `
                            <button class="btn btn-outline"
                                    onclick="executeScript('main', {'project_file': '${project.file_path}'})">
                                Follow Up
                            </button>
                        `;
                    } else if (project.status === 'rejected') {
                        actionButtons = `
                        `;
                    }

                    // Common action buttons (available for all projects)
                    const commonButtons = `
                        <a href="/${project.file_path}" target="_blank" class="btn btn-view">View File</a>
                        <button class="btn btn-outline btn-script"
                                onclick="executeScript('evaluate', {'project_file': '${project.file_path}'})"
                                data-script="evaluate">
                            Re-evaluate
                        </button>
                    `;

                    return `
                        <tr>
                            <td>${project.retrieval_date ? new Date(project.retrieval_date).toLocaleString() : 'N/A'}</td>
                            <td>${project.eingestellt_date || 'N/A'}</td>
                            <td><a href="${project.url || '#'}" target="_blank">${project.title}</a></td>
                            <td>${project.company || 'N/A'}</td>
                            <td>${project.pre_eval_score !== null ? project.pre_eval_score + '%' : 'N/A'}</td>
                            <td>${project.llm_score !== null ? project.llm_score + '%' : 'N/A'}</td>
                            <td><span class="status-badge status-${project.status}">${project.status}</span></td>
                            <td class="actions-cell">
                                <div class="action-buttons" data-project-id="${project.id}">
                                    ${actionButtons}
                                    ${commonButtons}
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            // Event Listeners for controls
            document.getElementById('search-input').addEventListener('input', renderTable);
            document.getElementById('filter-scraped').addEventListener('change', renderTable);
            document.getElementById('filter-accepted').addEventListener('change', renderTable);
            document.getElementById('filter-rejected').addEventListener('change', renderTable);
            document.getElementById('filter-applied').addEventListener('change', renderTable);
            document.getElementById('filter-sent').addEventListener('change', renderTable);
            document.getElementById('filter-open').addEventListener('change', renderTable);
            document.getElementById('filter-archived').addEventListener('change', renderTable);
            document.getElementById('start-date').addEventListener('change', renderTable);
            document.getElementById('end-date').addEventListener('change', renderTable);
            
            document.getElementById('view-preset-select').addEventListener('change', (e) => {
                const presetKey = e.target.value;
                const preset = viewPresets[presetKey];

                if (preset) {
                    for (const filter in preset.filters) {
                        const checkbox = document.getElementById(`filter-${filter}`);
                        if (checkbox) {
                            checkbox.checked = preset.filters[filter];
                        }
                    }
                    
                    const datePresetSelect = document.getElementById('date-preset');
                    if (preset.date_range && datePresetSelect) {
                        datePresetSelect.value = preset.date_range;
                        // Manually trigger the change event to apply the date range
                        datePresetSelect.dispatchEvent(new Event('change'));
                    } else {
                        // Reset date range if not specified in preset
                        document.getElementById('start-date').value = '';
                        document.getElementById('end-date').value = '';
                        datePresetSelect.value = '';
                    }
                }
                
                renderTable();
            });

            document.getElementById('date-preset').addEventListener('change', (e) => {
                const preset = e.target.value;
                const today = new Date();
                let startDate = new Date();
                
                if (preset === 'today') {
                    startDate.setDate(today.getDate());
                } else if (preset === 'last_day') {
                    startDate.setDate(today.getDate() - 1);
                } else if (preset === 'last_2_days') {
                    startDate.setDate(today.getDate() - 2);
                } else if (preset === 'last_3_days') {
                    startDate.setDate(today.getDate() - 3);
                } else if (preset === 'last_week') {
                    startDate.setDate(today.getDate() - 7);
                } else if (preset === 'last_2_weeks') {
                    startDate.setDate(today.getDate() - 14);
                } else if (preset === 'last_month') {
                    startDate.setMonth(today.getMonth() - 1);
                } else {
                     document.getElementById('start-date').value = '';
                     document.getElementById('end-date').value = '';
                }

                if (preset === 'all_time') {
                    document.getElementById('start-date').value = '';
                    document.getElementById('end-date').value = '';
                } else {
                    document.getElementById('start-date').value = startDate.toISOString().split('T')[0];
                    document.getElementById('end-date').value = today.toISOString().split('T')[0];
                }
                renderTable();
            });


            // Event listener for table header sorting
             document.querySelectorAll('#project-table th').forEach(header => {
                header.addEventListener('click', () => {
                    const column = header.dataset.sort;
                    if(column){
                        const order = (currentSort.column === column && currentSort.order === 'asc') ? 'desc' : 'asc';
                        currentSort = { column, order };
                        renderTable();
                    }
                });
            });
            
            populateViewPresets();
            loadProjectData();
        });
    </script>

</body>
</html>
